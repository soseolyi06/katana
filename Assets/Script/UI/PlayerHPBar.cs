using UnityEngine;
using UnityEngine.UI;

public class PlayerHPBar : MonoBehaviour
{
    // ---------------------------------------------------------
    // HP바(이미지)의 Fill Amount를 갱신할 Image 컴포넌트
    // - Bar 오브젝트에 붙어있는 Image를 연결하면 된다.
    // ---------------------------------------------------------
    [Header("UI")]
    public Image hpFillImage;

    // ---------------------------------------------------------
    // 플레이어의 현재 체력을 들고 있는 컴포넌트
    // - Player 오브젝트에 붙은 PlayerHP를 연결하면 된다.
    // ---------------------------------------------------------
    [Header("Target")]
    public PlayerHP playerHp;

    void Awake()
    {
        // ---------------------------------------------------------
        // 안전장치 1) Image를 인스펙터에 안 넣었으면
        // 같은 오브젝트(Bar)에서 자동으로 찾아본다.
        // ---------------------------------------------------------
        if (hpFillImage == null)
            hpFillImage = GetComponent<Image>();
    }

    void Update()
    {
        // ---------------------------------------------------------
        // 1) 연결이 안 되었으면 실행하지 않는다 (NullReference 방지)
        // ---------------------------------------------------------
        if (hpFillImage == null) return;
        if (playerHp == null) return;
        if (PlayerStatManager.I == null) return;

        // ---------------------------------------------------------
        // 2) StatManager에서 "최종 최대체력"을 가져온다
        // - 너의 구조상 maxHp는 StatManager가 계산한 finalMaxHp가 정답
        // ---------------------------------------------------------
        int maxHp = PlayerStatManager.I.finalMaxHp;

        // ---------------------------------------------------------
        // 3) 안전장치 2) maxHp가 0이하가 되면 나눗셈이 터지니까 최소 1로 보정
        // ---------------------------------------------------------
        if (maxHp <= 0) maxHp = 1;

        // ---------------------------------------------------------
        // 4) fillAmount 계산 (0~1)
        // - currentHp / maxHp
        // - float 캐스팅을 안 하면 정수 나눗셈이 되어 0/1만 나오니 꼭 float로 변환
        // ---------------------------------------------------------
        float ratio = (float)playerHp.currentHp / (float)maxHp;

        // ---------------------------------------------------------
        // 5) 혹시 값이 범위를 벗어나도 UI가 깨지지 않게 0~1로 고정
        // ---------------------------------------------------------
        ratio = Mathf.Clamp01(ratio);

        // ---------------------------------------------------------
        // 6) 최종적으로 Image의 fillAmount에 반영
        // ---------------------------------------------------------
        hpFillImage.fillAmount = ratio;
    }
}
